% !TEX encoding = UTF-8 Unicode
\documentclass[12pt,a4paper]{book}

\usepackage{geometry}
\geometry{top=3cm,bottom=2cm,left=3cm,right=3cm}

\usepackage{subfiles} % load .tex files

%% ============
%% === font ===
%% ============
\usepackage{xeCJK} % must be imported before fontspec
\usepackage{fontspec}
\setmainfont[
  Ligatures=TeX,
  SmallCapsFont=Times New Roman,
  SmallCapsFeatures={Letters=SmallCaps},
]{Times New Roman}
% \setCJKmainfont{NotoSansCJK-Light.ttc}
\setCJKmainfont{STKaiti.ttf}

\usepackage[american]{babel}
\usepackage{csquotes}

%% ===== Chinese characters in bold ===== %%
% value > 0
\def\xeCJKembold{0.4}

% hack into xeCJK, you don't need to understand it
\def\saveCJKnode{\dimen255\lastkern}
\def\restoreCJKnode{\kern-\dimen255\kern\dimen255}

% save old definition of \CJKsymbol and \CJKpunctsymbol for CJK output
\let\CJKoldsymbol\CJKsymbol
\let\CJKoldpunctsymbol\CJKpunctsymbol

% apply pdf literal fake bold
\def\CJKfakeboldsymbol#1{%
  \special{pdf:literal direct 2 Tr \xeCJKembold\space w}%
  \CJKoldsymbol{#1}%
  \saveCJKnode
  \special{pdf:literal direct 0 Tr}%
  \restoreCJKnode}
\def\CJKfakeboldpunctsymbol#1{%
  \special{pdf:literal direct 2 Tr \xeCJKembold\space w}%
  \CJKoldpunctsymbol{#1}%
  \saveCJKnode
  \special{pdf:literal direct 0 Tr}%
  \restoreCJKnode}
\newcommand\CJKfakebold[1]{%
  \let\CJKsymbol\CJKfakeboldsymbol
  \let\CJKpunctsymbol\CJKfakeboldpunctsymbol
  #1%
  \let\CJKsymbol\CJKoldsymbol
  \let\CJKpunctsymbol\CJKoldpunctsymbol}
%% ========== %%

%% =====================
%% === header/footer ===
%% =====================
\usepackage{fancyhdr}
\fancyhf{} % clear header/footer
\cfoot{\thepage} % page number in footer
\pagestyle{fancy}
\renewcommand{\headrulewidth}{0pt} % removes line in header

\usepackage[clearempty,raggedright,explicit]{titlesec} % removes page number when a page is without content; % left justifed for headings and subheadings
% use `flushleft` for blocks, `raggedright` for document settings
% https://www.overleaf.com/learn/latex/text_alignment#Left-justified_text
\newcommand{\nodoublepage}{\let\cleardoublepage\clearpage} % no insertion of blank pages

%% =========================
%% === table of contents ===
%% =========================
\addto\captionsamerican{\renewcommand{\contentsname}{Table of Contents}} % default (babel package): Contents

\usepackage[nottoc]{tocbibind} % toc, lof and lot on toc; no toc
\usepackage{tocloft,calc} % imports calc to use \widthof
\renewcommand\cftchappresnum{\chaptername\space}
\addtocontents{toc}{\protect\setlength{\cftchapnumwidth}{2.5cm}}

%% ===== decrease title spacing ===== %%
% \makeatletter
% \def\@makechapterhead#1{%
%   \vspace*{35\p@}
%   {\parindent \z@ \raggedright \normalfont
%     \ifnum \c@secnumdepth >\m@ne
%         \huge\bfseries \@chapapp\space \thechapter
%         \par\nobreak
%         \vskip 20\p@
%     \fi
%     \interlinepenalty\@M
%     \Huge \bfseries #1\par\nobreak
%     \vskip 40\p@
%   }}
% \def\@makeschapterhead#1{%
% \vspace*{25\p@}
%   {\parindent \z@ \raggedright
%     \normalfont
%     \interlinepenalty\@M
%     \Huge \bfseries  #1\par\nobreak
%     \vskip 40\p@
%   }}
% \makeatother
%% ========== %%

\usepackage[toc,title]{appendix}

\newcommand{\keywords}[1]{\noindent\textbf{Keywords:\space{#1}}}
\newcommand{\keywordsZH}[1]{\noindent\CJKfakebold{關鍵詞：\space{#1}}}

%% ==================
%% === paragraphs ===
%% ==================
\newcommand{\titlepagestyle}{\fontsize{18}{18}\selectfont}

\linespread{1.5} % double spacing
% \renewcommand{\baselinestretch}{2} % double spacing

\usepackage{indentfirst} % default: no identfirst
\setlength{\parindent}{15pt}

%% ========================
%% === figures & tables ===
%% ========================
\usepackage{graphicx} % inserts images
\usepackage{multirow} % inserts multirow tables
\usepackage{array} % discontinuous vertical rule
\usepackage{makecell} % newlines in cells
\usepackage{tabularx}
\usepackage{longtable}

\usepackage{float} % imports to use H
\usepackage{placeins} % imports to use \FloatBarrier after inserting figures/tables to avoid placing them across sections
\usepackage{cellspace} % vertical centering for figures

\usepackage{csvsimple} % import csv files

%% ===== figure/table weighting ===== %%
% source: https://www.researchgate.net/post/Does_anybody_know_how_can_I_order_figures_exactly_in_the_position_we_call_in_Latex_template
\def\topfraction{0.9} % 90 percent of the page may be used by floats on top
\def\bottomfraction{0.9} % the same at the bottom
\def\textfraction{0.01} % at least 1 percent must be reserved for text
%% ========== %%

\usepackage[labelsep=period]{caption}

\usepackage{booktabs} % imports to use \toprule

\newcommand{\fref}[1]{Figure \ref{#1}}
\newcommand{\tref}[1]{Table \ref{#1}}

\newcommand{\footnotesymbol}{*}

%% ===== (dis)continuous vertical line ===== %%
\newcommand{\cmidnospacing}{\aboverulesep = 0mm \belowrulesep = 0mm}\cmidnospacing
%% ========== %%

%% ===== vertical centering for figures ===== %%
% source: https://tex.stackexchange.com/questions/230655/how-to-vertically-center-image-in-table-cell
\setlength\cellspacetoplimit{7pt}
\setlength\cellspacebottomlimit{7pt}

\newcommand\cincludegraphics[2][]{\raisebox{-0.3\height}{\includegraphics[#1]{#2}}}
%% ========== %%

%% ===================
%% === enumeration ===
%% ===================
\usepackage{enumitem} % formatting itemize and enumerate

%% =============
%% === links ===
%% =============
\usepackage[linktocpage=true,hidelinks]{hyperref} % clickable on page number instead of on title
\usepackage[linktocpage=true]{hyperref}
\usepackage{url}
\urlstyle{same} % url font (options: tt, rm, sf, same)

%% ============
%% === time ===
%% ============
\usepackage{datetime}
\usepackage{advdate}
\newdateformat{monthyearEN}{\monthname[\the\month] \the\year} % e.g. July 2020
\newcommand{\yearZH}{\AdvYear{-1911}\the\year} % e.g. 109
\newcommand{\lastaccessed}{Last accessed: \mbox{\the\year-\AdvMonth{-1}\twodigit{\the\month}-\twodigit{\the\day}}} % e.g. 2020-07-01

%% ===============
%% === numbers ===
%% ===============
\usepackage{siunitx}
\usepackage{amsmath}

%% ==================
%% === references ===
%% ==================
\usepackage[
  backend=biber,
  style=authoryear-comp, % comp: same author, different years in one citation
  sorting=nyt,
  useprefix=true,
  dashed=false,
  maxcitenames=2,
  maxbibnames=99,
  doi=false,
  backref=true
]{biblatex}
\usepackage{xpatch}
\addbibresource{references.bib}

\DefineBibliographyStrings{english}{%
  bibliography={References},
}

\newcommand{\asincite}[1]{\parencite[as cited in][]{#1}} % e.g. (as cited in A, 2000) 
\newcommand{\dictcite}[1]{(``\citeauthor{#1}",~\cite*{#1})} % e.g. ("Home", 2020)

%% ===== add period after last name ===== %%
\makeatletter
\renewbibmacro*{author}{%
  \ifboolexpr{
    test \ifuseauthor
    and
    not test {\ifnameundef{author}}
  }
    {\usebibmacro{bbx:dashcheck}
       {\bibnamedash}
       {\usebibmacro{bbx:savehash}%
        \printnames{author}%
        \iffieldundef{authortype}
          {\setunit{\addperiod\space}}
          {\setunit{\addcomma\space}}}%
     \iffieldundef{authortype}
       {}
       {\usebibmacro{authorstrg}%
        \setunit{\addperiod\addspace}}}%
    {\global\undef\bbx@lasthash
     \usebibmacro{labeltitle}%
     \setunit*{\adddperiod\space}}%
  \usebibmacro{date+extrayear}}

\newbibmacro*{bbx:editor}[1]{%
  \ifboolexpr{
    test \ifuseeditor
    and
    not test {\ifnameundef{editor}}
  }
    {\usebibmacro{bbx:dashcheck}
       {\bibnamedash}
       {\printnames{editor}%
        \setunit{\addcomma\space}%
        \usebibmacro{bbx:savehash}}%
     \usebibmacro{#1}%
     \clearname{editor}%
     \setunit{\addperiod\space}}%
    {\global\undef\bbx@lasthash
     \usebibmacro{labeltitle}%
     \setunit*{\addperiod\space}}%
  \usebibmacro{date+extrayear}}

\newbibmacro*{bbx:translator}[1]{%
  \ifboolexpr{
    test \ifusetranslator
    and
    not test {\ifnameundef{translator}}
  }
    {\usebibmacro{bbx:dashcheck}
       {\bibnamedash}
       {\printnames{translator}%
        \setunit{\addcomma\space}%
        \usebibmacro{bbx:savehash}}%
     \usebibmacro{translator+othersstrg}%
     \clearname{translator}%
     \setunit{\addperiod\space}}%
    {\global\undef\bbx@lasthash
     \usebibmacro{labeltitle}%
     \setunit*{\addspace}}%
  \usebibmacro{date+extrayear}}
\makeatother
%% ========== %%

%% ===== change "dot" before number into "parenthesis" between number ===== %%
\renewbibmacro*{volume+number+eid}{%
  \printfield{volume}%
%  \setunit*{\adddot}% DELETED
%  \setunit*{\addnbspace}% NEW (optional); there's also \addnbthinspace
  \printfield{number}%
  \setunit{\addcomma\space}%
  \printfield{eid}}
\DeclareFieldFormat[article]{volume}{\textit{#1}}
\DeclareFieldFormat[article]{number}{\mkbibparens{#1}}
\DeclareFieldFormat[article]{pages}{\mkcomprange{#1}}

\DeclareFieldFormat{journal}{\mkbibemph{#1}\isdot}
\renewbibmacro*{journal+issuetitle}{%
  \usebibmacro{journal}%
  \setunit*{\addcomma\space}%
  \iffieldundef{series}
    {}
    {\newunit
     \printfield{series}%
     \setunit{\addspace}}%
  \usebibmacro{volume+number+eid}%
  \setunit{\addspace}%
  \usebibmacro{issue+date}%
  \setunit{\addcolon\space}%
  \usebibmacro{issue}%
  \newunit}
%% ========== %%

\DeclareFieldFormat[book]{title}{#1} % remove "" around title
\DeclareFieldFormat*{title}{\textit{#1}} % remove "" around title
\DeclareFieldFormat*{url}{\url{#1}} % remove "URL:" before url

%% ===== remove period between title and titleaddon ===== %%
\renewbibmacro*{title}{%
  \ifboolexpr{
    test {\iffieldundef{title}}
    and
    test {\iffieldundef{titleaddon}}
  }
    {}
    {\printtext[title]{%
       \printfield[titlecase]{title}%
       \setunit{\addspace}%
       \printfield[titlecase]{titleaddon}}%
     \newunit}}%
%% ========== %%

%% ===== remove "In" for article ===== %%
\renewbibmacro{in:}{%
  \ifentrytype{article}{}{%
  \printtext{\bibstring{in}\printunit{\intitlepunct}}%
  }}
%% ========== %%

%% ===== count number of references ===== %%
\newcounter{refs}
\makeatletter
\defbibenvironment{counter}
  {\setcounter{refs}{0}
  \renewcommand{\blx@driver}[1]{}
  }
  {We have \therefs  references}
  {\stepcounter{refs}}
\makeatother
%% ========== %%

%% =========================
%% === in-text citations ===
%% =========================
\renewcommand*{\nameyeardelim}{\addcomma\addspace} % comma between name and year
\renewcommand*{\postnotedelim}{\addcolon\space} % colon before page
\DeclareFieldFormat{postnote}{\mkcomprange{#1}}
\DeclareFieldFormat{multipostnote}{\mkcomprange{#1}} % remove page prefix

%% =========================
%% === string formatting ===
%% =========================
\newcommand{\rspace}{\hspace{-3pt}}

\newcommand{\zh}[3]{#1\space\textit{#2}\space`#3'}

\def\endyear#1{~-- \SI[group-separator={}]{#1}{}}
\newcommand{\dynasty}[2]{#1 \endyear{#2}}
\newcommand{\tang}{\dynasty{618}{907}}
\newcommand{\song}{\dynasty{960}{1279}}
\newcommand{\yuan}{\dynasty{1271}{1368}}
\newcommand{\ming}{\dynasty{1368}{1644}}
\newcommand{\qing}{\dynasty{1644}{1911}}
\newcommand{\dynastyASBC}{\dynasty{1981}{2007}}
\newcommand{\dynastyDcard}{\dynasty{2011}{2019}}

\usepackage{glossaries}
\newcommand{\jia}{\textit{jiā}\space}
\newcommand{\sts}{\textsuperscript{st}}
\newcommand{\nds}{\textsuperscript{nd}}
\newcommand{\ths}{\textsuperscript{th}}
\setacronymstyle{long-short}
\newacronym{sgns}{SGNS}{Skip-gram with negative sampling}
\newacronym{cbow}{CBOW}{Continuous Bag-Of-Words}
\newacronym{svdppmi}{SVD-based PPMI}{Singular value decomposition on Positive Pointwise Mutual Information}
\newacronym{tsne}{t-SNE}{t-distributed Stochastic Neighboring Embedding}
\newacronym{pca}{PCA}{Principal Component Analysis}
\newacronym{tot}{TOT}{Topic-Over-Time}
\newacronym{vnc}{VNC}{Variability-based neighbor clustering}
\newacronym{ctext}{CTEXT}{Chinese Text Project}
\newacronym{asbc}{ASBC}{Academia Sinica Balanced Corpus of Modern Chinese}

%% =================
%% === watermark ===
%% =================
\usepackage{eso-pic}
\usepackage{tikz}

%% ===== watermark at upper right ===== %%
\newcommand\AtPageUpperRight[1]{\AtPageUpperLeft{%
   \makebox[\paperwidth][r]{#1}}}
%% ========== %%

%% ===== watermark at lower right ===== %%
\newcommand\AtPageLowerRight[1]{\AtPageLowerLeft{%
   \makebox[\paperwidth][r]{#1}}}
%% ========== %%

%% ===== move left ===== %%
\makeatletter
\newcommand*{\horizontalmove}[2]{%
  \settowidth{\@tempdima}{#2}%
  \makebox[\@tempdima]{\hspace*{#1}#2}%
}
\makeatother
%% ========== %%

\newcommand{\addwatermark}{
  \AddToShipoutPictureBG{%
  \AtPageUpperRight{% move left and down by 2.5m, 0.5 of photo size
    \raisebox{-2.5cm-\height}{{\horizontalmove{-2.5cm}{%
    \transparent{0.5}\includegraphics[scale=0.5]{figures/watermark.pdf}
    }
    }}
  }
  \AtPageLowerRight{%
    \raisebox{1cm}{\horizontalmove{-4cm}{%
      \textbf{doi:10.6342/NTU202004346}
      }
    }
  }
} 
}

\hyphenchar\font=-1
\sloppy
\begin{document}

    % \subfile{Metachapters/Titlepage.tex}
    % \nodoublepage

    \addwatermark

    \subfile{Metachapters/Titlepage.tex}
    \nodoublepage

    \frontmatter
    \begingroup
    \nodoublepage
      % \subfile{Metachapters/Thanks.tex}
      \subfile{Metachapters/AbstractZH.tex}
      \subfile{Metachapters/AbstractEN.tex}
      
      \newpage
      \tableofcontents

      \newpage
      \listoffigures

      \newpage
      \listoftables
    \endgroup

    \mainmatter
      \subfile{Chapters/Chapter1.tex}
      \subfile{Chapters/Chapter2.tex}
      \subfile{Chapters/Chapter3.tex}
      \subfile{Chapters/Chapter4.tex}
      \subfile{Chapters/Chapter5.tex}

    % \backmatter
      \newpage
      % \nocite{*}
      % \printbibliography[env=counter] % count number of references
      \printbibliography[heading=bibintoc]
      
      \nodoublepage
      \begin{appendices}
      \titleformat{\chapter}[display]
  {\normalfont\large\bfseries}% <- font for label "Appendix A", default \huge
  {\chaptertitlename\ \thechapter}
  {20pt}
  {\large}% <- font for title, default \Huge
        \subfile{Appendices/AppendixA.tex}
        \subfile{Appendices/AppendixB.tex}
      \end{appendices}
\end{document}

%% TODO
% .5 opacity of watermark
% appendix name in toc